import requests
import json
import time


# 返回历史数据和当日详细数据
def get_tencent_data():
	url1 = "https://view.inews.qq.com/g2/getOnsInfo?name=disease_h5"
	url2 = "https://view.inews.qq.com/g2/getOnsInfo?name=disease_other"
	headers = {
		'user-agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.70 Safari/537.36'
	}
	r1 = requests.get(url1, headers)
	r2 = requests.get(url2, headers)

	# json字符串转字典
	res1 = json.loads(r1.text)
	res2 = json.loads(r2.text)
	data1 = r1.text["data"]
	mudanjiang = r',{"name":"牡丹江","adcode":"231000","date":"2022/11/09","today":{"confirm":0,"confirmCuts":0,"isUpdated":true,"wzz_add":"0","local_confirm_add":0},"total":'
	data1 = data1.replace(mudanjiang, r']}]}]}')
	data_all1 = json.loads(data1)
	data_all2 = json.loads(res2["data"])

	# 历史数据
	history = {}
	for i in data_all2["chinaDayList"]:
		ds = "2022." + i["date"]
		tup = time.strptime(ds, "%Y.%m.%d")  # 匹配时间
		ds = time.strftime("%Y-%m-%d", tup)  # 改变时间输入格式，不然插入数据库会报错，数据库是datatime格式
		confirm = i["confirm"]
		suspect = i["suspect"]
		heal = i["heal"]
		dead = i["dead"]
		history[ds] = {"confirm": confirm, "suspect": suspect, "heal": heal, "dead": dead}
	for i in data_all2["chinaDayAddList"]:
		ds = "2022." + i["date"]
		tup = time.strptime(ds, "%Y.%m.%d")  # 匹配时间
		ds = time.strftime("%Y-%m-%d", tup)  # 改变时间输入格式，不然插入数据库会报错，数据库是datatime格式
		confirm = i["confirm"]
		suspect = i["suspect"]
		heal = i["heal"]
		dead = i["dead"]
		history[ds].update({"confirm_add": confirm, "suspect_add": suspect, "heal_add": heal, "dead_add": dead})

	# 当日详细数据
	details = []
	update_time = data_all1["lastUpdateTime"]
	data_country = data_all1["areaTree"]  # list 25个国家
	data_province = data_country[0]["children"]  # 中国各省
	for pro_infos in data_province:
		province = pro_infos["name"]  # 省名
		for city_infos in pro_infos["children"]:
			city = city_infos["name"]
			confirm = city_infos["total"]["confirm"]
			confirm_add = city_infos["today"]["confirm"]
			heal = city_infos["total"]["heal"]
			dead = city_infos["total"]["dead"]
			details.append([update_time, province, city, confirm, confirm_add, heal, dead])
	return history, details

def get_details():
	url1 = "https://view.inews.qq.com/g2/getOnsInfo?name=disease_h5"
	url2 = "https://view.inews.qq.com/g2/getOnsInfo?name=disease_other"
	headers = {
		'user-agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.70 Safari/537.36'
	}
	r1 = requests.get(url1, headers)
	r2 = requests.get(url2, headers)

	# json字符串转字典
	res1 = json.loads(r1.text)
	res2 = json.loads(r2.text)
	data1 = res1["data"]
	mudanjiang = r',{"name":"牡丹江","adcode":"231000","date":"2022/11/09","today":{"confirm":0,"confirmCuts":0,"isUpdated":true,"wzz_add":"0","local_confirm_add":0},"total":'
	data1 = data1.replace(mudanjiang, r']}]}]}')
	data_all1 = json.loads(data1)
	# 当日详细数据
	details = []
	update_time = data_all1["lastUpdateTime"]
	data_country = data_all1["areaTree"]  # list 25个国家
	data_province = data_country[0]["children"]  # 中国各省
	for pro_infos in data_province:
		province = pro_infos["name"]  # 省名
		for city_infos in pro_infos["children"]:
			city = city_infos["name"]
			confirm = city_infos["total"]["confirm"]
			confirm_add = city_infos["today"]["confirm"]
			heal = city_infos["total"]["heal"]
			dead = city_infos["total"]["dead"]
			details.append([update_time, province, city, confirm, confirm_add, heal, dead])
	return details
if __name__ =="__main__":
	de=get_details()
	print(de)
